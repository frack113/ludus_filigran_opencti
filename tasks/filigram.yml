# tasks/filigram.yml 
---

- name: Install required packages (Git)
  apt:
    name:
      - git
    state: present
  when: ansible_os_family == 'Debian'

- name: Create /opt/filigram directory if it doesn't exist
  file:
    path: /opt/filigram
    state: directory
    mode: '0755'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

- name: Check if Filigran repository already exists
  stat:
    path: /opt/filigram/.git
  register: repo_exists

- name: Clone Filigran XTM Docker repository
  git:
    repo: https://github.com/FiligranHQ/xtm-docker.git
    dest: /opt/filigram
    version: main 
    force: "{{ not repo_exists.stat.exists }}"
  register: git_clone_result
  failed_when: git_clone_result is changed and git_clone_result is not succeeded

- name: Create .env file from template
  ansible.builtin.template:
    src: files/env.j2
    dest: /opt/filigram/.env
    mode: '0644'
  when: git_clone_result is succeeded

- name: Verify Docker is installed and running
  block:
    - name: Check if Docker is installed
      command: docker --version
      register: docker_installed
      changed_when: false
      ignore_errors: yes

    - name: Fail if Docker is not installed (except in check mode)
      meta: end_host
      when: docker_installed.rc != 0 and not ansible_check_mode

    - name: Ensure Docker is running
      service:
        name: docker
        state: started
        enabled: yes
      when: docker_installed.rc == 0 or ansible_check_mode

- name: Pull Filigran images only if not present
  community.docker.docker_compose_v2_pull:
    project_src: /opt/filigram
  when: git_clone_result is succeeded

- name: Start Filigran docker with proper error handling
  community.docker.docker_compose_v2:
    project_src: /opt/filigram
    state: present
    wait: true
    wait_timeout: 180
    pull: missing
  register: compose_result
  when: git_clone_result is succeeded

- name: Fail if Docker Compose failed to start services
  meta: end_host
  when: compose_result is defined and compose_result.failed

- name: Wait until Filigran HTTP status is 200
  uri:
    url: 'http://localhost:8080/'
    return_content: yes
    validate_certs: no
    status_code:
      - 200
  until: uri_output.status == 200
  retries: 24
  delay: 5
  register: uri_output
  when: git_clone_result is succeeded and compose_result is defined and not compose_result.failed
